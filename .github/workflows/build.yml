name: Build ImmortalWrt MT798x

on:
  schedule:
    # 每周一北京时间 0:00 (UTC 周日 16:00)
    - cron: '0 16 * * 0'
  workflow_dispatch:  # 允许手动触发

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_FILE: mt7987_mt7992.config
  TZ: Asia/Shanghai
  SOURCE_DIR: immortalwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Free up additional disk space
        run: |
          echo "释放额外磁盘空间..."
          sudo apt-get remove -y '^llvm-.*' '^dotnet-.*' 'php.*' azure-cli google-cloud-sdk google-chrome-stable firefox powershell mono-devel --fix-missing 2>/dev/null || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo apt-get install -y ccache

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ env.CONFIG_FILE }}
          max-size: 2G

      - name: Clone or update source code
        run: |
          if [ -d "$SOURCE_DIR/.git" ]; then
            echo "源码目录存在，执行 git pull 更新..."
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
            cd ..
          else
            echo "首次克隆源码..."
            rm -rf $SOURCE_DIR
            git clone -b $REPO_BRANCH --single-branch --filter=blob:none $REPO_URL $SOURCE_DIR
          fi

      - name: Add QModem feed
        run: |
          cd $SOURCE_DIR
          # 确保 QModem feed 存在
          if ! grep -q "qmodem" feeds.conf.default; then
            echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          fi

      - name: Cache dl directory
        uses: actions/cache@v4
        with:
          path: ${{ env.SOURCE_DIR }}/dl
          key: ${{ runner.os }}-dl-${{ hashFiles(format('{0}/feeds.conf.default', env.SOURCE_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-dl-

      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
          key: ${{ runner.os }}-toolchain-${{ env.CONFIG_FILE }}-v1
          restore-keys: |
            ${{ runner.os }}-toolchain-${{ env.CONFIG_FILE }}-
            ${{ runner.os }}-toolchain-

      - name: Update and install feeds
        run: |
          cd $SOURCE_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 强制安装 QModem 相关包以覆盖原有包
          ./scripts/feeds install -a -f -p qmodem

      - name: Configure build
        run: |
          cd $SOURCE_DIR
          cp -f defconfig/$CONFIG_FILE .config
          
          # 取消原有 modem 相关选项
          sed -i '/CONFIG_PACKAGE_luci-app-modem/d' .config
          sed -i '/CONFIG_PACKAGE_luci-app-3ginfo-lite/d' .config
          sed -i '/CONFIG_PACKAGE_luci-app-sms-tool/d' .config
          
          # 启用 QModem 及其依赖
          echo 'CONFIG_PACKAGE_luci-app-qmodem=y' >> .config
          echo 'CONFIG_PACKAGE_qmodem=y' >> .config
          echo 'CONFIG_PACKAGE_sms-tool_q=y' >> .config
          echo 'CONFIG_PACKAGE_quectel-cm-5g=y' >> .config
          
          # 启用 UPnP
          echo 'CONFIG_PACKAGE_luci-app-upnp=y' >> .config
          
          # 启用 vlmcsd (KMS 激活服务)
          echo 'CONFIG_PACKAGE_luci-app-vlmcsd=y' >> .config
          echo 'CONFIG_PACKAGE_vlmcsd=y' >> .config
          
          # 启用 AdGuard Home
          echo 'CONFIG_PACKAGE_luci-app-adguardhome=y' >> .config
          echo 'CONFIG_PACKAGE_adguardhome=y' >> .config
          
          # 启用 ramfree
          echo 'CONFIG_PACKAGE_luci-app-ramfree=y' >> .config
          
          # 启用 HomeProxy
          echo 'CONFIG_PACKAGE_luci-app-homeproxy=y' >> .config
          
          # 启用 ccache 加速
          echo 'CONFIG_CCACHE=y' >> .config
          
          make defconfig
          
          # 保存配置文件到仓库
          cp .config ../config/current.config

      - name: Download packages
        run: |
          cd $SOURCE_DIR
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile toolchain
        run: |
          cd $SOURCE_DIR
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: Compile firmware
        run: |
          cd $SOURCE_DIR
          echo "开始编译，使用 $(nproc) 线程..."
          export PATH="/usr/lib/ccache:$PATH"
          make -j$(nproc) || make -j1 V=s
          echo "ccache 统计信息:"
          ccache -s

      - name: Check disk space
        if: always()
        run: df -h

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp -rf $SOURCE_DIR/bin/targets/*/*/* artifacts/ 2>/dev/null || true
          rm -rf artifacts/packages
          rm -f artifacts/*.buildinfo
          rm -f artifacts/*.manifest
          rm -f artifacts/sha256sums
          ls -lh artifacts/

      - name: Save build info to repository
        run: |
          mkdir -p config logs
          
          # 保存构建信息
          echo "构建时间: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" > logs/last_build.txt
          echo "源码分支: $REPO_BRANCH" >> logs/last_build.txt
          echo "配置文件: $CONFIG_FILE" >> logs/last_build.txt
          echo "源码 Commit: $(cd $SOURCE_DIR && git rev-parse HEAD)" >> logs/last_build.txt
          
          # 保存 feeds.conf
          cp $SOURCE_DIR/feeds.conf.default config/feeds.conf.default

      - name: Commit build info
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/ logs/ || true
          git diff --staged --quiet || git commit -m "Update build info $(TZ='Asia/Shanghai' date +'%Y-%m-%d')"
          git push || true

      - name: Get current date
        id: date
        run: echo "date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-MT7987-MT7992-${{ steps.date.outputs.date }}
          path: artifacts/
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.date.outputs.date }}
          name: ImmortalWrt MT7987/MT7992 Build ${{ steps.date.outputs.date }}
          body: |
            自动构建 ImmortalWrt MT7987/MT7992 固件
            
            构建时间: ${{ steps.date.outputs.date }}
            源码分支: ${{ env.REPO_BRANCH }}
            配置文件: ${{ env.CONFIG_FILE }}
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
